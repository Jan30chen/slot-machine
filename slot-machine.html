<!--
 * @Date: 2021-07-19 16:08:06
 * @Author: chenwb
 * @LastEditTime: 2021-07-23 15:17:27
 * @LastEditors: chenwb
 * @FilePath: \slot-machine\slot-machine.html
 * @Descripttion: Html+CSS+Js å®ç°è€è™æœºæ¸¸æˆ
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Slot Machine</title>
  <style>
    /* æœºä½“ */
    div#main {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding-bottom: 20px;
      margin: 0 auto;

      width: 300px;
      border: red 3px solid;
      background-color: #282c34;
    }
    /* æ ‡é¢˜ */
    div#top {
      width: 100%;
      color: #fff;
      text-align: center;
    }
    /* åº•éƒ¨ */
    div#bottom {
      width: 100%;
      margin-top: 25px;
      text-align: center;
    }
    div#bottom > button {
      width: 100px;
      height: 30px;
      border: none;
      cursor: pointer;
      font-size: 20px;
    }
    div#bottom > button:disabled {
      cursor: not-allowed;
      background-color: #555;
    }
    button#start-btn {
      color: #fff;
      background-color: red;
    }
    button#recharge-btn {
      color: #fff;
      background-color: #64b0ed;
    }
    /* å•ä¸ªæ˜¾ç¤ºå± */
    div.ceil {
      position: relative;
      overflow: hidden;
      /* å®½é«˜ */
      width: 60px;
      height: 100px;
      margin: 0 10px;
      border: red 2px solid;
    }
    /* æŒ‡é’ˆ */
    div.triangle { 
      position: absolute;
      width: 0;
      height: 0;
      right: 0;
      top: 45px;
      z-index: 5;
      /* ä¸‰è§’å½¢ */
      border-width: 5px 10px;
      border-color: transparent;
      border-style: solid;
      border-right-color: red;
    }
    /* æ˜¾ç¤ºå±åçš„æ»šåŠ¨å¸¦ */
    ul.nums {
      width: 100%;
      position: relative;
      top: -25px;
      /* æ¸…é™¤è‡ªå¸¦æ ·å¼ */
      list-style: none;
      padding-left: 0;
      margin: 0;
      /* è¿‡æ¸¡æ—¶é—´ */
      transition: top 0.1s;
    } 
    /* æ„æˆæ»šåŠ¨å¸¦çš„å°å…ƒç´  */
    ul.nums>li {
      top: 0px;
      height: 50px;
      text-align: center;
      /* å­—ä½“ */
      font-size: 30px;
      line-height: 50px;
      color: #fff;
      background-color: #fbe032;
    }
    /* è½¬åŠ¨ä¸­æ ·å¼ï¼šæ™ƒåŠ¨ã€Yè½´æ¨¡ç³Š */
    div#ceil1.active {
      animation: shake2 0.5s linear, shake2 0.5s linear 1s;
    }
    div#ceil2.active {
      animation: shake2 0.5s linear, shake2 0.5s linear 2s;
    }
    div#ceil3.active {
      animation: shake2 0.5s linear, shake2 0.5s linear 3s;
    }
    div#ceil1.active > ul.nums {
      animation: shake 1s linear 2 1s alternate;
      filter: url(#blur);
    }
    div#ceil2.active > ul.nums {
      animation: shake 1s linear 2 2s alternate;
      filter: url(#blur);
    }
    div#ceil3.active > ul.nums {
      animation: shake 1s linear 2 3s alternate;
      filter: url(#blur);
    }
    /* åŠ¨ç”»-æ™ƒåŠ¨æ•ˆæœ */
    @keyframes shake {
      from {
        transform: translateY(0px) 
      }
      to {
        transform: translateY(-10px);
      }
    }
    @keyframes shake2 {
      0% {
        transform: translateY(0px);
      }
      25% {
        transform: translateY(-6px) 
      }
      50% {
        transform: translateY(6px);
      }
      100% {
        transform: translateY(0px);
      }
    }
    /* è®¡åˆ†æ¿ */
    table{
      width: 250px;
      margin: 0 auto;
      margin-top: 50px;
    }
    table, td {
      border: 1px solid #333;
    }
    thead, tfoot {
      background-color: #333;
      color: #fff;
    }
    td {
      text-align: center;
    }
    td:last-child {
      background-color: #075530;
      color: #fbe032;
    }
  </style>
</head>
<body>
  <div id="main">
    <div id="top">
      <h2 id="top-title">ğŸ° Slot Machine</h2>
      <p id="balance"></p>
    </div>
    <div id="ceil1" class="ceil">
      <ul class="nums"></ul>
      <div class="triangle"></div>
    </div>
    <div id="ceil2" class="ceil">
      <ul class="nums"></ul>
      <div class="triangle"></div>
    </div>
    <div id="ceil3" class="ceil">
      <ul class="nums"></ul>
      <div class="triangle"></div>
    </div>
    <div id="bottom">
      <button id="start-btn" onclick="begin()">Begin</button>
      <!-- <button id="recharge-btn" onclick="recharge()">Recharge</button> -->
    </div>
  </div>
  <div id="history">
    <table>
      <thead>
        <tr>
          <th>count</th>
          <th>â… </th>
          <th>â…¡</th>
          <th>â…¢</th>
          <th>$</th>
        </tr>
      </thead>
      <tbody id="history-content"></tbody>
    </table>
  </div>
  <svg>
    <filter id="blur">
      <feGaussianBlur in="SourceGraphic" stdDeviation="0 10"/>
    </filter>
  </svg>
  <script>
    const list = ['ğŸ“', 'ğŸ', 'ğŸ¥­', 'ğŸ', 'ğŸŒ', 'ğŸ‹', 'ğŸŠ', 'ğŸ‰', 'ğŸˆ', 'ğŸ‡']
    // const list = [
    //   'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“',
    //   'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 'ğŸ', 
    //   'ğŸ¥­', 'ğŸ¥­', 'ğŸ¥­', 'ğŸ¥­', 
    //   'ğŸ', 'ğŸ', 
    //   'ğŸŒ',
    //   'ğŸ‡'
    //   'ğŸˆ', 'ğŸˆ', 
    //   'ğŸ‰', 'ğŸ‰', 'ğŸ‰', 'ğŸ‰', 
    //   'ğŸŠ', 'ğŸŠ', 'ğŸŠ', 'ğŸŠ', 'ğŸŠ', 'ğŸŠ', 
    //   'ğŸ‹', 'ğŸ‹', 'ğŸ‹', 'ğŸ‹', 'ğŸ‹', 'ğŸ‹', 'ğŸ‹', 'ğŸ‹', 
    // ]
    const listLength = list.length
    const ceilArray = document.getElementsByClassName('ceil')
    const ulArray   = document.getElementsByClassName('nums')
    // æ¸¸æˆç›¸å…³å¸¸é‡æ•°å€¼
    const BEGIN = 10    // åˆå§‹å¸æ•°
    const TARGET = 100  // ç›®æ ‡å¸æ•°
    const PRICE = 2     // å•æ¬¡æŠ•å¸
    const AWARD_L1 = 50 // ä¸‰è¿è·å¸
    const AWARD_L2 = 5  // ä¸¤è¿è·å¸
    // æ¸¸æˆç›¸å…³å˜é‡æ•°å€¼
    let count = 0
    let balance = BEGIN
    let rolling = false
    let currents = []
    let over = false
    // å•ä¸ªå…ƒç´ é«˜åº¦ä¸æ˜¾ç¤ºå±é«˜åº¦
    let heightLi, heightCeil 

    function init() {
      initCeil()
      initTable()
      initKey()
      // è®¾ç½®ä½™é¢
      document.getElementById('balance').innerText = `ğŸ’µ ${balance}`
      // è®¾ç½®é«˜åº¦
      heightCeil = ceilArray[0].clientHeight
      heightLi = ulArray[0].getElementsByTagName('li')[0].clientHeight
    }
    // æ’å…¥liå…ƒç´ ï¼Œåˆå§‹åŒ–æ»šåŠ¨å¸¦
    function initCeil() {
      let _list = list.slice()
      // å‰åå¢åŠ å ä½å›¾æ¡ˆ
      _list.push(_list[0])
      _list.unshift(_list[listLength-1])
      // éå†æ’å…¥
      for(let i=0;i<3;i++) {
        _list.forEach(item => {
          let _li = document.createElement('li')
          _li.innerText = item
          ulArray[i].appendChild(_li)
        })
      }
    }
    // åˆå§‹åŒ–è®¡åˆ†æ¿
    function initTable() {
      // æ’å…¥ç¤ºä¾‹
      let _tbody  = document.getElementById('history-content')
      let _column1 = document.createElement('tr')
      let _column2 = document.createElement('tr')
      _column1.innerHTML = `
        <td>ğŸ¥‡</td>
        <td>${list[0]}</td>
        <td>${list[0]}</td>
        <td>${list[0]}</td>
        <td>+${AWARD_L1}</td>
      `
      _column2.innerHTML = `
        <td>ğŸ¥ˆ</td>
        <td>${list[0]}</td>
        <td>${list[0]}</td>
        <td>${list[1]}</td>
        <td>+${AWARD_L2}</td>
      `
      _tbody.appendChild(_column1)
      _tbody.appendChild(_column2)
    }
    // åˆå§‹åŒ–é”®ç›˜ç›‘å¬
    function initKey() {
      document.onkeydown = function(e) {
        if( e.key == 'c' && !over ) {
          recharge()
        }
      }
    }
    // è®¾ç½®Yè½´åç§»é‡ï¼ŒèŒƒå›´[1, listLength]
    function setTop(element, offset) {
      element.style.top = `${(offset+1)*(-heightLi)+(heightCeil-heightLi)/2}px`
    }
    // æ»šåŠ¨ç¬¬indexä¸ªå•ä½
    function roll(index) {
      currents[index] = currents[index]+1 < listLength ? currents[index]+1:1
      setTop(ulArray[index], currents[index])
    }
    // åœæ­¢æ»šåŠ¨ç¬¬indexä¸ªå•ä½ï¼Œåœç•™åœ¨ç¬¬numä¸ª
    function stop(index, num) {
      currents[index] = num
      setTop(ulArray[index], currents[index])
      // æ¸…é™¤åŠ¨ç”»
      setTimeout(() => {
        ceilArray[index].className = ceilArray[index].className.replace(' active','')
      }, 0)
      // åœæ­¢åæ“ä½œ
      if(index>=2) {
        count += 1
        // è®¡ç®—å¾—åˆ†ã€æ·»åŠ è®°å½•
        let award = getAward(currents)
        changeBalance(award)
        addRecord(currents, award)
        changeBtnState(false)
        rolling = false
        over = ifOver()
      }
    }
    // è®¡ç®—ä½™é¢
    function changeBalance(award=10) {
      let _balanceElement = document.getElementById('balance')
      balance = balance + award
      _balanceElement.innerText = `ğŸ’µ ${balance}`
    }
    // æ›´æ”¹æŒ‰é’®çŠ¶æ€
    function changeBtnState(state=false) {
      document.getElementById('start-btn').disabled = state
    }
    // æ·»åŠ è®°å½•
    function addRecord(arr, award) {
      let _tbody  = document.getElementById('history-content')
      let _column = document.createElement('tr')
      _column.innerHTML = `
        <td>${count}</td>
        <td>${list[arr[0]]}</td>
        <td>${list[arr[1]]}</td>
        <td>${list[arr[2]]}</td>
        <td>${award>0?`+${award}`:award}</td>
      `
      _tbody.appendChild(_column)
    }
    // è·å–å•æ¬¡å¾—åˆ†
    function getAward(arr) {
      let awardLevel = Array.from(new Set(arr)).length
      let awardSum
      switch(awardLevel) {
        case 1:
          awardSum = AWARD_L1
          break
        case 2:
          awardSum = AWARD_L2
          break
        default:
          awardSum = 0
      }
      return awardSum
    }
    // éšæœºè·å–[0, listLength-1]æ•´æ•°
    function getRandom() {
      return Math.floor(Math.random()*listLength)
    }
    // ç¬¬indexä¸ªå•ä½å¼€å¯åŠ¨ç”»
    function addAnima(index) {
      setTimeout(() => {
        ceilArray[index].className += ' active'
      }, 0)
    }
    // æ¸¸æˆç»“æŸ
    function ifOver() {
      if( balance<PRICE ) {
        document.getElementById('top-title').innerText = 'ğŸ¥€ GAME OVER'
        changeBtnState(true)
        return true
      } else if( balance>=TARGET ) {
        document.getElementById('top-title').innerText = 'ğŸ‘‘ YOU WIN!'
        changeBtnState(true)
        return true
      }
      return false
    }
    // å¼€å§‹
    function begin() {
      if(over || rolling) return
      rolling = true
      changeBtnState(true)
      changeBalance(-PRICE)
      let timers = []
      for(let i=0;i<3;i++) {
        addAnima(i) // æ·»åŠ æ»šåŠ¨æ ·å¼
        // å¼€å§‹æ»šåŠ¨
        timers[i] = setInterval(()=>{ 
          roll(i) 
        }, 100)
        // æ·»åŠ å®šæ—¶å™¨åœæ­¢
        setTimeout(() => {
          stop(i, getRandom())
          clearInterval(timers[i])
        }, (i+1)*1100);
      }
    }
    // è‡ªåŠ¨è¿è¡Œ
    function auto() {
      setInterval(begin, 4*1000)
    }
    // å……å€¼
    function recharge() {
      changeBalance()
    }
    // æ‰“ä¹±
    function foulUp(arr) {
      for (let i=1; i<arr.length; i++) {
        const random = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[random]] = [arr[random], arr[i]];
      }
    }
    
    // foulUp(list)
    init()
    // auto()
  </script>
</body>
</html>